#!/bin/bash
# LPIC-1 Training Platform - Unified Launcher
# Single entry point for all training features
#
# Usage: lpic1 [command] [args...]
#
# When invoked without arguments, launches the TUI menu.
# When invoked with arguments, passes them to the appropriate backend.

set -euo pipefail

# Get script directory (resolve symlinks)
SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd)"
ROOT_DIR="$(cd "${SCRIPT_DIR}/.." && pwd)"
CORE_DIR="${ROOT_DIR}/core"
TUI_DIR="${ROOT_DIR}/apps/tui_textual"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

# ============================================================================
# Debug Mode
# ============================================================================

show_debug() {
    echo -e "${BOLD}=== LPIC-1 Debug Info ===${NC}"
    echo
    echo -e "${CYAN}Paths:${NC}"
    echo "  SCRIPT_DIR: $SCRIPT_DIR"
    echo "  ROOT_DIR:   $ROOT_DIR"
    echo "  CORE_DIR:   $CORE_DIR"
    echo "  TUI_DIR:    $TUI_DIR"
    echo

    echo -e "${CYAN}Core Files:${NC}"
    [[ -f "$CORE_DIR/lpic-train" ]] && echo -e "  lpic-train:     ${GREEN}OK${NC}" || echo -e "  lpic-train:     ${RED}MISSING${NC}"
    [[ -f "$CORE_DIR/lpic-check" ]] && echo -e "  lpic-check:     ${GREEN}OK${NC}" || echo -e "  lpic-check:     ${RED}MISSING${NC}"
    [[ -f "$TUI_DIR/app.py" ]] && echo -e "  tui_textual:    ${GREEN}OK${NC}" || echo -e "  tui_textual:    ${RED}MISSING${NC}"
    [[ -f "$CORE_DIR/training/common.sh" ]] && echo -e "  common.sh:      ${GREEN}OK${NC}" || echo -e "  common.sh:      ${RED}MISSING${NC}"
    echo

    echo -e "${CYAN}TUI Tools:${NC}"
    command -v python3 &>/dev/null && echo -e "  python3: ${GREEN}installed${NC}" || echo -e "  python3: ${YELLOW}NOT FOUND${NC}"
    python3 -c "import textual" &>/dev/null && echo -e "  textual: ${GREEN}installed${NC}" || echo -e "  textual: ${YELLOW}NOT FOUND${NC}"
    echo

    echo -e "${CYAN}Exercise Files:${NC}"
    local exercises_dir="$CORE_DIR/training/exercises"
    local topics=(grep sed awk find tar permissions processes users networking filesystems systemd)
    for topic in "${topics[@]}"; do
        local exercise_file="${exercises_dir}/${topic}-exercises.sh"
        if [[ -f "$exercise_file" ]]; then
            echo -e "  ${topic}-exercises.sh: ${GREEN}OK${NC}"
        else
            echo -e "  ${topic}-exercises.sh: ${RED}MISSING${NC}"
        fi
    done
    echo

    echo -e "${CYAN}Progress Database:${NC}"
    local db_file="/opt/LPIC-1/data/progress.db"
    echo "  Path: $db_file"
    if [[ -f "$db_file" ]]; then
        echo -e "  Status: ${GREEN}exists${NC}"
        local size
        size=$(stat --printf="%s" "$db_file" 2>/dev/null || echo "unknown")
        echo "  Size: $size bytes"
    else
        echo -e "  Status: ${YELLOW}NOT FOUND${NC} (will be created on first run)"
    fi
    echo

    echo -e "${CYAN}Environment:${NC}"
    echo "  HOME: $HOME"
    echo "  PWD:  $PWD"
    echo "  SHELL: ${SHELL:-unknown}"
    echo
}

# ============================================================================
# Help
# ============================================================================

show_help() {
    cat << 'EOF'
LPIC-1 Training Platform

Usage: lpic1 [command] [args...]

When run without arguments, launches the interactive TUI menu.

LEARNING:
  (no args)              Launch interactive TUI menu
  learn <topic>          Learn a topic with live examples
  practice <topic>       Guided exercises with hints
  test <topic>           Assessment without hints
  sandbox [topic]        Free experimentation mode

MUSCLE MEMORY:
  drill [topic]          Quick-fire recall drills (builds speed)
  mix                    Interleaved practice (mixed topics)
  smart                  Smart review based on weak areas

PROGRESS:
  status                 Show training progress
  check <objective>      Check objective completion (e.g., 101.1)
  exam [--time N]        Timed exam simulation

EXAMPLES:
  lpic1                  # Launch TUI menu
  lpic1 learn grep       # Learn grep patterns
  lpic1 practice find    # Practice find exercises
  lpic1 drill chmod      # Quick drills for chmod
  lpic1 mix              # Mixed-topic practice
  lpic1 exam --time 60   # 60-minute exam simulation

TOPICS:
  Text:     grep, sed, awk
  Files:    find, tar, permissions
  System:   processes, systemd
  Admin:    users, networking, filesystems

LEARNING PATH:
  1. learn  → Understand the concepts
  2. practice → Guided exercises with hints
  3. drill  → Build speed and automaticity
  4. mix    → Strengthen cross-topic skills
  5. test   → Assess without hints
  6. exam   → Full simulation
EOF
}

# ============================================================================
# TUI Detection
# ============================================================================

tui_available() {
    command -v python3 &>/dev/null && python3 -c "import textual" &>/dev/null
}

# ============================================================================
# Main Entry Point
# ============================================================================

main() {
    # No arguments - launch TUI
    if [[ $# -eq 0 ]]; then
        if ! tui_available; then
            echo -e "${YELLOW}Textual UI not available${NC}"
            echo
            echo "Install Textual:"
            echo "  Ubuntu/Debian: sudo apt install python3-pip && pip3 install textual"
            echo "  Fedora/RHEL:   sudo dnf install python3-pip && pip3 install textual"
            echo
            echo "Falling back to command-line interface..."
            echo
            "${CORE_DIR}/lpic-train" --help
            exit 0
        fi

        # Launch Textual TUI
        exec "${TUI_DIR}/run.sh"
    fi

    # Parse command
    local command="$1"
    shift

    case "$command" in
        # Learning modes - delegate to lpic-train
        learn|practice|sandbox|test|status|review|topics|drill|mix|smart|smart-review|interleaved)
            exec "${CORE_DIR}/lpic-train" "$command" "$@"
            ;;

        # Validation modes - delegate to lpic-check
        check|objective)
            exec "${CORE_DIR}/lpic-check" objective "$@"
            ;;

        topic)
            exec "${CORE_DIR}/lpic-check" topic "$@"
            ;;

        progress)
            exec "${CORE_DIR}/lpic-check" progress "$@"
            ;;

        verify|verify-packages)
            exec "${CORE_DIR}/lpic-check" verify-packages "$@"
            ;;

        exam|exam-mode)
            exec "${CORE_DIR}/lpic-check" exam-mode "$@"
            ;;

        self-test)
            exec "${CORE_DIR}/lpic-check" self-test "$@"
            ;;

        # Skills - delegate to skill-checker
        skills|session)
            exec "${CORE_DIR}/skill-checker.sh" session "$@"
            ;;

        # TUI-specific
        tui|menu)
            if ! tui_available; then
                echo -e "${RED}Textual UI not available${NC}"
                echo "Install with: sudo dnf install python3-pip && pip3 install textual"
                exit 1
            fi
            exec "${TUI_DIR}/run.sh"
            ;;

        # Help
        -h|--help|help)
            show_help
            ;;

        # Debug mode
        -d|--debug|debug)
            show_debug
            exit 0
            ;;

        # Unknown command - check if it's a topic
        *)
            # Try to resolve as topic (learn mode)
            if [[ -f "${CORE_DIR}/training/lessons/${command}.sh" ]]; then
                echo -e "${CYAN}Tip: Use 'lpic1 learn $command' for explicit mode${NC}"
                echo
                exec "${CORE_DIR}/lpic-train" learn "$command" "$@"
            else
                echo -e "${RED}Unknown command: $command${NC}"
                echo
                show_help
                exit 1
            fi
            ;;
    esac
}

main "$@"
